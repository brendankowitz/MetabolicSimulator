<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metabolic Simulation Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #2c3e50; }
        .controls { margin-bottom: 20px; }
        select { padding: 8px; font-size: 16px; border-radius: 4px; }
        canvas { max-height: 400px; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .status-item { background: #eef2f7; padding: 15px; border-radius: 6px; text-align: center; }
        .status-value { font-size: 24px; font-weight: bold; color: #2980b9; }
        .status-label { font-size: 14px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§¬ Metabolic Digital Twin</h1>
        
        <div class="card">
            <h3>Upload Simulation Data</h3>
            <p>Select the <code>whole_body_simulation.csv</code> file generated by the console app.</p>
            <input type="file" id="csvFile" accept=".csv" />
        </div>

        <div id="dashboard" style="display:none;">
            <div class="status-grid" id="statusGrid">
                <!-- KPI Cards will go here -->
            </div>

            <div class="card">
                <div class="controls">
                    <label>Select Pathway View: </label>
                    <select id="groupSelector">
                        <option value="energy">Energy (ATP, NADH, Glucose)</option>
                        <option value="methylation">Methylation (SAM, Hcy, 5-MTHF)</option>
                        <option value="inflammation">Inflammation (ROS, GSH, NF-kB)</option>
                        <option value="krebs">Krebs Cycle (Citrate, Succinate)</option>
                        <option value="all">All Metabolites</option>
                    </select>
                </div>
                <canvas id="mainChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let simulationData = [];
        let labels = [];

        // Metabolite Groupings for easier viewing
        const groups = {
            energy: ['atp_cyto', 'nadh_mito', 'nad_plus_mito', 'glucose_cell', 'pyruvate'],
            methylation: ['sam', 'sah', 'hcy', 'methyl_thf', 'met'],
            inflammation: ['ros', 'gsh_cyto', 'gssg_cyto', 'nfkb_active', 'cortisol'],
            krebs: ['citrate', 'alpha_kg', 'succinate', 'fumarate', 'malate']
        };

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                    document.getElementById('dashboard').style.display = 'block';
                }
            });
        });

        function processData(data) {
            simulationData = data;
            labels = data.map(row => row.Time);
            updateKPIs(data[data.length - 1]);
            updateChart('energy');
        }

        function updateKPIs(finalRow) {
            const kpis = [
                { id: 'atp_cyto', label: 'ATP Energy' },
                { id: 'nad_plus_mito', label: 'Mito NAD+' },
                { id: 'sam', label: 'SAM (Methyl)' },
                { id: 'gsh_cyto', label: 'Glutathione' }
            ];

            const container = document.getElementById('statusGrid');
            container.innerHTML = '';

            kpis.forEach(kpi => {
                const val = finalRow[kpi.id];
                if (val !== undefined) {
                    const div = document.createElement('div');
                    div.className = 'status-item';
                    div.innerHTML = `
                        <div class="status-value">${val.toFixed(4)} mM</div>
                        <div class="status-label">${kpi.label}</div>
                    `;
                    container.appendChild(div);
                }
            });
        }

        document.getElementById('groupSelector').addEventListener('change', (e) => {
            updateChart(e.target.value);
        });

        function updateChart(groupName) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (chartInstance) chartInstance.destroy();

            const keysToGraph = groupName === 'all' 
                ? Object.keys(simulationData[0]).filter(k => k !== 'Time')
                : groups[groupName];

            const datasets = keysToGraph.map((key, index) => {
                // Check if key exists in CSV
                if (simulationData[0][key] === undefined) return null;

                const color = `hsl(${(index * 137.5) % 360}, 70%, 50%)`; // Golden angle approximation for distinct colors
                return {
                    label: key,
                    data: simulationData.map(row => row[key]),
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0
                };
            }).filter(d => d !== null);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: { title: { display: true, text: 'Time (seconds)' } },
                        y: { title: { display: true, text: 'Concentration (mM)' } }
                    }
                }
            });
        }
    </script>
</body>
</html>
